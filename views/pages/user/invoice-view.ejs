<!DOCTYPE html>
<html lang="id">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>
			Invoice <%= invoice.invoice_number %> - E-Invoice Restu Production
		</title>
		<link rel="stylesheet" href="/css/style.css" />
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					"Helvetica Neue", Arial, sans-serif;
				background-color: #f5f5f5;
				color: #333;
			}

			.header {
				background: white;
				padding: 1.5rem;
				border-bottom: 1px solid #eee;
				display: flex;
				justify-content: space-between;
				align-items: center;
				max-width: 100vw;
			}

			.header-left h1 {
				font-size: 1.5rem;
				color: #333;
			}

			.header-right {
				display: flex;
				gap: 1rem;
				/* margin-right: 2%; */
			}

			.btn {
				padding: 0.5rem 1rem;
				border: none;
				border-radius: 4px;
				font-size: 0.9rem;
				cursor: pointer;
				transition: background-color 0.2s;
				text-decoration: none;
				display: inline-block;
			}

			.btn-primary {
				background: #667eea;
				color: white;
			}

			.btn-primary:hover {
				background: #5568d3;
			}

			.btn-secondary {
				background: #6c757d;
				color: white;
			}

			.btn-secondary:hover {
				background: #5a6268;
			}

			.container {
				max-width: 900px;
				margin: 2rem auto;
				padding: 0 1rem;
			}

			.invoice-box {
				background: white;
				padding: 2rem;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
				margin-bottom: 2rem;
			}

			.invoice-header {
				display: grid;
				grid-template-columns: 1fr 1fr;
				margin-bottom: 2rem;
				padding-bottom: 2rem;
				border-bottom: 2px solid #eee;
				gap: 2rem;
			}

			.company-info h3 {
				color: #667eea;
				margin-bottom: 0.5rem;
				font-size: 1.2rem;
			}

			.company-info p {
				font-size: 0.9rem;
				color: #666;
				line-height: 1.6;
			}

			.invoice-info {
				text-align: right;
			}

			.invoice-info h4 {
				margin-top: 0.5rem;
				font-size: 1rem;
				color: #555;
			}

			.invoice-info p {
				font-size: 0.9rem;
				color: #666;
			}

			.invoice-number {
				font-size: 1.5rem;
				font-weight: bold;
				color: #333;
				margin-bottom: 0.5rem;
			}

			.invoice-status {
				display: inline-block;
				padding: 0.25rem 0.75rem;
				border-radius: 20px;
				font-size: 0.85rem;
				font-weight: 500;
			}

			.status-draft {
				background: #e2e3e5;
				color: #383d41;
			}
			.status-issued {
				background: #cfe2ff;
				color: #084298;
			}
			.status-sent {
				background: #cff4fc;
				color: #055160;
			}
			.status-paid {
				background: #d1e7dd;
				color: #0f5132;
			}
			.status-overdue {
				background: #f8d7da;
				color: #842029;
			}
			.status-cancelled {
				background: #f5c2c7;
				color: #842029;
			}

			.recipient-details {
				margin-top: 2rem;
				padding: 1.5rem;
				background: #f8f9fa;
				border-radius: 4px;
			}

			.recipient-details h4 {
				margin-bottom: 1rem;
				color: #333;
			}

			.recipient-details p {
				margin: 0.5rem 0;
				font-size: 0.95rem;
				color: #666;
			}

			.items-table {
				width: 100%;
				margin-top: 2rem;
				border-collapse: collapse;
			}

			.items-table thead {
				background: #f8f9fa;
			}

			.items-table th {
				padding: 0.75rem;
				text-align: left;
				font-weight: 600;
				color: #333;
				border-bottom: 2px solid #ddd;
			}

			.items-table td {
				padding: 0.75rem;
				border-bottom: 1px solid #eee;
				color: #666;
			}

			.items-table tr:hover {
				background: #f9f9f9;
			}

			.total-section {
				margin-top: 2rem;
				text-align: right;
			}

			.total-row {
				display: grid;
				grid-template-columns: auto auto;
				/* gap: 1.2rem; */
				max-width: 300px;
				margin-left: auto;
			}

			.total-row-item {
				display: contents;
			}

			.total-row-label {
				text-align: right;
				font-weight: 500;
				color: #666;
				padding: 0.5rem 0;
			}

			.total-row-value {
				text-align: right;
				color: #333;
				padding: 0.5rem 0;
			}

			.total-row-value.grand-total {
				font-size: 1.2rem;
				font-weight: bold;
				color: #2a51ff;
				border-top: 2px solid #ddd;
				padding-top: 1rem;
				padding-bottom: 1rem;
			}

			.bank-details {
				margin-top: 2rem;
				padding: 1.5rem;
				background: #f8f9fa;
				border-radius: 4px;
				border-left: 4px solid #fa5764;
			}

			.bank-details h4 {
				margin-bottom: 1rem;
				color: #333;
			}

			.bank-details p {
				margin: 0.5rem 0;
				font-size: 0.95rem;
				color: #666;
			}

			@media print {
				.header,
				.btn-print-area {
					display: none;
				}
				body {
					background: white;
				}
				.invoice-box {
					box-shadow: none;
					margin: 0;
				}
			}

			@media (max-width: 768px) {
				.invoice-header {
					grid-template-columns: 1fr;
				}

				.invoice-info {
					text-align: left;
				}

				.header {
					flex-direction: column;
					gap: 1rem;
				}

				.header-right {
					flex-direction: column;
					width: 100%;
				}

				.btn {
					width: 100%;
					text-align: center;
				}

				/* Mobile responsive table - card layout */
				.items-table {
					display: block;
					border: none;
				}

				.items-table thead {
					display: none;
				}

				.items-table tbody {
					display: block;
				}

				.items-table tr {
					display: block;
					border: 1px solid #ddd;
					border-radius: 4px;
					margin-bottom: 1rem;
					padding: 1rem;
					background: white;
				}

				.items-table td {
					display: block;
					padding: 0.5rem 0;
					border: none;
					text-align: right;
					position: relative;
					padding-left: 50%;
					min-height: 1.75rem;
				}

				.items-table td:before {
					content: attr(data-label);
					position: absolute;
					left: 0;
					font-weight: 600;
					color: #667eea;
					text-align: left;
					width: 45%;
					font-size: 0.85rem;
				}

				.items-table td:first-child {
					padding-left: 0;
					padding-top: 0;
					padding-bottom: 0.75rem;
					font-weight: 600;
					color: #333;
					font-size: 1rem;
					border-bottom: 2px solid #ddd;
					margin-bottom: 0.75rem;
					text-align: left;
				}

				.items-table td:first-child:before {
					content: "";
					display: none;
				}
			}
		</style>
	</head>
	<body>
		<div
			class="header"
			data-invoice-id="<%= invoice.id %>"
			data-invoice-number="<%= invoice.invoice_number %>"
			data-recipient-phone="<%= invoice.recipient_phone %>"
			data-share-token="<%= typeof shareToken !== 'undefined' ? shareToken : '' %>"
			data-is-admin="<%= typeof isAdmin !== 'undefined' ? (isAdmin ? 'true' : 'false') : 'false' %>"
		>
			<div class="header-left">
				<h1>Invoice</h1>
			</div>
			<div class="header-right btn-print-area">
				<!-- Template Selector untuk Download -->
				<select
					id="templateSelect"
					class="btn btn-primary"
					style="padding: 0.5rem 1rem; cursor: pointer"
				>
					<option value="">Download Invoice</option>
					<option value="normal">Unduh PDF (Normal)</option>
					<option value="dotmatrix">Unduh PDF (Dot Matrix)</option>
				</select>

				<a href="/" class="btn btn-secondary">Kembali</a>
			</div>
		</div>

		<div class="container">
			<div class="invoice-box">
				<!-- Header Invoice -->
				<div class="invoice-header">
					<div class="company-info">
						<% if (invoice.logo_path) { %>
						<img
							src="<%= invoice.logo_path %>"
							alt="Logo"
							style="height: 60px; margin-bottom: 1rem"
						/>
						<% } %>
						<h3><%= invoice.company_name %></h3>
						<p><%= invoice.company_address %></p>
						<p>ðŸ“ž <%= invoice.company_phone %></p>
					</div>
					<div class="invoice-info">
						<div class="invoice-number"><%= invoice.invoice_number %></div>
						<span class="invoice-status status-<%= invoice.status %>">
							<%= invoice.status.toUpperCase() %>
						</span>
						<h4>Tanggal Invoice</h4>
						<p>
							<%= new Date(invoice.invoice_date).toLocaleDateString('id-ID') %>
						</p>
						<% if (invoice.due_date) { %>
						<h4>Tanggal Jatuh Tempo</h4>
						<p><%= new Date(invoice.due_date).toLocaleDateString('id-ID') %></p>
						<% } %>
					</div>
				</div>

				<!-- Detail Penerima -->
				<div class="recipient-details">
					<h4>Detail Penerima</h4>
					<p>
						<strong>Nama:</strong>
						<%= invoice.recipient_name %>
					</p>
					<p>
						<strong>Nomor Telepon:</strong>
						<%= invoice.recipient_phone %>
					</p>
					<% if (invoice.recipient_npwp) { %>
					<p>
						<strong>NPWP:</strong>
						<%= invoice.recipient_npwp %>
					</p>
					<% } %> <% if (invoice.recipient_address) { %>
					<p>
						<strong>Alamat:</strong>
						<br />
						<%= invoice.recipient_address %>
					</p>
					<% } %>
				</div>

				<!-- Tabel Item -->
				<table class="items-table">
					<thead>
						<tr>
							<th style="text-align: center">Barang/Jasa</th>
							<th style="text-align: center">Satuan</th>
							<th style="text-align: center">Qty</th>
							<th style="text-align: right">Harga Satuan</th>
							<th style="text-align: right">Total</th>
						</tr>
					</thead>
					<tbody>
						<% invoice.items.forEach(item => { %>
						<tr>
							<td><%= item.description || item.name %></td>
							<td data-label="Satuan" style="text-align: center">
								<%= item.unit || "-" %>
							</td>
							<td data-label="Qty" style="text-align: center">
								<%= item.quantity || item.qty %>
							</td>
							<td data-label="Harga Satuan" style="text-align: right">
								Rp <%= Math.round(item.price || item.unit_price ||
								0).toLocaleString('id-ID', { minimumFractionDigits: 0,
								maximumFractionDigits: 0 }) %>
							</td>
							<td data-label="Total" style="text-align: right">
								Rp <%= Math.round((item.quantity || item.qty || 0) * (item.price
								|| item.unit_price || 0)).toLocaleString('id-ID', {
								minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
							</td>
						</tr>
						<% }); %>
					</tbody>
				</table>

				<!-- Total Section -->
				<div class="total-section">
					<div class="total-row">
						<% let subtotal = 0; invoice.items.forEach(item => { subtotal +=
						(item.quantity || item.qty || 0) * (item.price || item.unit_price ||
						0); }); %>
						<div class="total-row-item">
							<div class="total-row-label">Subtotal:</div>
							<div class="total-row-value">
								Rp <%= Math.round(subtotal).toLocaleString('id-ID', {
								minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
							</div>
						</div>

						<% invoice.taxes.forEach(tax => { const taxAmount = tax.amount !==
						undefined ? tax.amount : (subtotal * (tax.percentage || 0) / 100);
						%>
						<div class="total-row-item">
							<div class="total-row-label">
								<%= tax.name %> (<%= tax.percentage || 0 %>%):
							</div>
							<div class="total-row-value">
								Rp <%= Math.round(taxAmount).toLocaleString('id-ID', {
								minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
							</div>
						</div>
						<% }); %>

						<div class="total-row-item">
							<div class="total-row-label">Total:</div>
							<div class="total-row-value grand-total">
								Rp <%= Math.round(invoice.total_amount ||
								0).toLocaleString('id-ID', { minimumFractionDigits: 0,
								maximumFractionDigits: 0 }) %>
							</div>
						</div>
					</div>
				</div>

				<!-- Bank Details -->
				<% if (invoice.status != 'paid' && invoice.status != 'cancelled' &&
				invoice.bank_name) { %>
				<div class="bank-details">
					<h4>Informasi Pembayaran</h4>
					<p>
						<strong>Nama Bank:</strong>
						<%= invoice.bank_name %>
					</p>
					<p>
						<strong>Nomor Rekening:</strong>
						<%= invoice.bank_account_number %>
					</p>
					<p>
						<strong>Atas Nama:</strong>
						<%= invoice.bank_account_name %>
					</p>
				</div>
				<% } %>
			</div>
		</div>

		<%- include ('../../partials/footer') %>

		<script>
			// Get invoice data from HTML attributes
			const header = document.querySelector("[data-invoice-id]")
			const invoiceId = header.dataset.invoiceId
			const invoiceNumber = header.dataset.invoiceNumber
			const recipientPhone = header.dataset.recipientPhone
			const shareToken = header.dataset.shareToken
			const isAdmin = header.dataset.isAdmin === "true"

			// Template selector handler untuk download PDF
			if (document.getElementById("templateSelect")) {
				document
					.getElementById("templateSelect")
					.addEventListener("change", function (e) {
						const template = e.target.value
						if (!template) return

						if (shareToken) {
							// User accessing via shared link
							window.location.href = `/invoice/share/${shareToken}/pdf?template=${template}`
						} else if (isAdmin) {
							// Admin accessing invoice
							window.location.href = `/admin/invoice/${invoiceId}/pdf/${template}`
						} else {
							// User accessing via check invoice form - submit form to download
							downloadInvoiceFromCheck(invoiceNumber, recipientPhone, template)
						}
					})
			}

			// Function untuk download invoice dari check invoice
			function downloadInvoiceFromCheck(
				invoiceNumber,
				recipientPhone,
				template,
			) {
				const form = document.createElement("form")
				form.method = "POST"
				form.action = "/invoice/check/pdf"

				const invoiceField = document.createElement("input")
				invoiceField.type = "hidden"
				invoiceField.name = "invoice_number"
				invoiceField.value = invoiceNumber

				const phoneField = document.createElement("input")
				phoneField.type = "hidden"
				phoneField.name = "recipient_phone"
				phoneField.value = recipientPhone

				const templateField = document.createElement("input")
				templateField.type = "hidden"
				templateField.name = "template"
				templateField.value = template

				form.appendChild(invoiceField)
				form.appendChild(phoneField)
				form.appendChild(templateField)

				document.body.appendChild(form)
				form.submit()
				document.body.removeChild(form)
			}

			// Print dengan template selector
			function handlePrintWithTemplate() {
				const selectElement = document.getElementById("printTemplateSelect")
				const selectedTemplate = selectElement.value

				if (!selectedTemplate) {
					selectElement.value = ""
					return
				}

				// Store selected template di session storage untuk print preview
				sessionStorage.setItem("printTemplate", selectedTemplate)

				// Trigger print dialog
				setTimeout(() => {
					window.print()
				}, 100)

				// Reset dropdown setelah print dialog ditutup
				setTimeout(() => {
					selectElement.value = ""
					sessionStorage.removeItem("printTemplate")
				}, 500)
			}

			// Prevent some common print issues
			window.addEventListener("beforeprint", () => {
				document.body.style.padding = "0"
				document.body.style.margin = "0"
			})
		</script>

		<!-- Print CSS untuk template berbeda -->
		<style media="print">
			@page {
				size: A4;
				margin: 0.5cm;
			}

			body {
				background: white;
				margin: 0;
				padding: 0;
			}

			.header,
			.btn-print-area {
				display: none !important;
			}

			.container {
				margin: 0;
				max-width: 100%;
			}

			.invoice-box {
				box-shadow: none;
				border: none;
				margin: 0;
				padding: 0;
				page-break-inside: avoid;
			}

			.invoice-header {
				margin-bottom: 20pt;
				padding-bottom: 10pt;
				border-bottom: 2pt solid #000;
				page-break-inside: avoid;
			}

			.recipient-details {
				margin: 15pt 0;
				padding: 10pt;
				border: 1pt solid #ccc;
				page-break-inside: avoid;
			}

			.items-table {
				width: 100%;
				border-collapse: collapse;
				margin: 15pt 0;
				page-break-inside: avoid;
			}

			.items-table th,
			.items-table td {
				border: 1pt solid #000;
				padding: 5pt;
				text-align: left;
				font-size: 10pt;
			}

			.items-table th {
				background: #e0e0e0;
				font-weight: bold;
			}

			.items-table td:nth-child(3),
			.items-table td:nth-child(4),
			.items-table td:nth-child(5),
			.items-table td:nth-child(6) {
				text-align: right;
			}

			.summary-section {
				margin: 20pt 0;
				text-align: right;
				page-break-inside: avoid;
			}

			.summary-line {
				margin: 3pt 0;
				padding: 2pt 0;
				font-size: 10pt;
			}

			.total-line {
				font-weight: bold;
				font-size: 12pt;
				border-top: 2pt solid #000;
				border-bottom: 2pt solid #000;
				padding: 5pt 0;
				margin-top: 10pt;
			}

			.qr-code-info {
				display: none !important;
			}

			table {
				page-break-inside: avoid;
			}

			.page-break {
				page-break-before: always;
			}
		</style>
	</body>
</html>
