<!DOCTYPE html>
<html lang="id">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Detail Invoice <%= invoice.invoice_number %> - Admin</title>
		<link rel="stylesheet" href="/css/admin-style.css" />
		<style>
			.detail-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 2rem;
				flex-wrap: wrap;
				gap: 1rem;
			}

			.invoice-number-display {
				font-size: 1.5rem;
				font-weight: bold;
				color: #333;
			}

			.invoice-status {
				display: inline-block;
				padding: 0.5rem 1rem;
				border-radius: 20px;
				font-size: 0.9rem;
				font-weight: 500;
			}

			.status-draft {
				background: #e2e3e5;
				color: #383d41;
			}
			.status-issued {
				background: #cfe2ff;
				color: #084298;
			}
			.status-sent {
				background: #cff4fc;
				color: #055160;
			}
			.status-paid {
				background: #d1e7dd;
				color: #0f5132;
			}
			.status-overdue {
				background: #f8d7da;
				color: #842029;
			}
			.status-cancelled {
				background: #f5c2c7;
				color: #842029;
			}

			.action-buttons {
				display: flex;
				gap: 0.5rem;
				flex-wrap: wrap;
			}

			.btn {
				padding: 0.5rem 1rem;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				text-decoration: none;
				display: inline-block;
				font-size: 0.9rem;
				transition: all 0.2s;
			}

			.btn-primary {
				background: #667eea;
				color: white;
			}

			.btn-primary:hover {
				background: #5568d3;
			}

			.btn-secondary {
				background: #6c757d;
				color: white;
			}

			.btn-secondary:hover {
				background: #5a6268;
			}

			.btn-danger {
				background: #dc3545;
				color: white;
			}

			.btn-danger:hover {
				background: #c82333;
			}

			.btn-success {
				background: #28a745;
				color: white;
			}

			.btn-success:hover {
				background: #218838;
			}

			.detail-container {
				display: grid;
				grid-template-columns: 2fr 1fr;
				gap: 2rem;
				margin-top: 2rem;
			}

			.detail-card {
				background: white;
				padding: 1.5rem;
				border-radius: 8px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.detail-card h3 {
				margin-bottom: 1rem;
				color: #333;
				border-bottom: 1px solid #eee;
				padding-bottom: 0.75rem;
			}

			.detail-row {
				display: grid;
				grid-template-columns: 150px 1fr;
				gap: 1rem;
				margin-bottom: 1rem;
				padding-bottom: 1rem;
				border-bottom: 1px solid #eee;
			}

			.detail-row:last-child {
				border-bottom: none;
				margin-bottom: 0;
				padding-bottom: 0;
			}

			.detail-label {
				font-weight: 600;
				color: #555;
			}

			.detail-value {
				color: #333;
			}

			.items-table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 1rem;
			}

			.items-table thead {
				background: #f8f9fa;
			}

			.items-table th {
				padding: 0.75rem;
				text-align: left;
				font-weight: 600;
				color: #333;
				border-bottom: 2px solid #ddd;
				font-size: 0.9rem;
			}

			.items-table td {
				padding: 0.75rem;
				border-bottom: 1px solid #eee;
				color: #666;
			}

			.items-table tr:hover {
				background: #f9f9f9;
			}

			.total-row {
				background: #f8f9fa;
				font-weight: 600;
				color: #333;
			}

			.total-value {
				text-align: right;
				color: #667eea;
			}

			.sidebar-section {
				margin-bottom: 2rem;
			}

			.sidebar-section h4 {
				margin-bottom: 1rem;
				color: #333;
				border-bottom: 1px solid #eee;
				padding-bottom: 0.75rem;
			}

			.status-update {
				display: flex;
				flex-direction: column;
				gap: 0.75rem;
			}

			.status-update select {
				padding: 0.5rem;
				border: 1px solid #ddd;
				border-radius: 4px;
			}

			.share-link-box {
				background: #f0f4ff;
				padding: 1rem;
				border-radius: 4px;
				border: 1px solid #cce0ff;
			}

			.share-link-box input {
				width: 100%;
				padding: 0.5rem;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 0.85rem;
				margin-bottom: 0.5rem;
			}

			.copy-btn {
				padding: 0.4rem 0.8rem;
				background: #28a745;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 0.85rem;
			}

			.copy-btn:hover {
				background: #218838;
			}

			@media (max-width: 768px) {
				.detail-container {
					grid-template-columns: 1fr;
				}

				.detail-header {
					flex-direction: column;
					align-items: flex-start;
				}

				.action-buttons {
					width: 100%;
					flex-direction: column;
				}

				.btn {
					width: 100%;
					text-align: center;
				}

				.items-table {
					font-size: 0.85rem;
				}

				.items-table th,
				.items-table td {
					padding: 0.5rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="admin-container">
			<!-- Sidebar Overlay -->
			<div class="sidebar-overlay" id="sidebarOverlay"></div>

			<!-- Sidebar -->
			<aside class="sidebar" id="sidebar">
				<div class="sidebar-header">
					<h2>E-Invoice</h2>
					<p>Restu Production</p>
				</div>

				<nav class="sidebar-nav">
					<a href="/admin/invoice/dashboard" class="nav-item">
						<span class="icon">ðŸ“Š</span>
						<span class="label">Dashboard</span>
					</a>
					<a href="/admin/invoice/create" class="nav-item">
						<span class="icon">âž•</span>
						<span class="label">Buat Invoice</span>
					</a>
					<a href="/admin/invoice/history" class="nav-item">
						<span class="icon">ðŸ“‹</span>
						<span class="label">Riwayat Invoice</span>
					</a>
				</nav>

				<div class="sidebar-footer">
					<a href="/auth/logout" class="logout-btn">
						<span class="icon">ðŸšª</span>
						<span class="label">Logout</span>
					</a>
				</div>
			</aside>

			<!-- Main Content -->
			<main class="main-content">
				<div class="top-bar">
					<div class="top-bar-left">
						<button class="hamburger-menu" id="hamburgerMenu">â˜°</button>
						<h1>Detail Invoice</h1>
					</div>
				</div>

				<!-- Header dengan nomor invoice dan aksi -->
				<div class="detail-header">
					<div>
						<div class="invoice-number-display">
							<%= invoice.invoice_number %>
						</div>
						<span class="invoice-status status-<%= invoice.status %>">
							<%= invoice.status.toUpperCase() %>
						</span>
					</div>
					<div class="action-buttons">
						<a
							href="/admin/invoice/<%= invoice.id %>/pdf/normal"
							class="btn btn-primary"
							download
						>
							Download PDF
						</a>
						<button class="btn btn-success" onclick="generateShareLink()">
							Generate Share Link
						</button>
						<a href="/admin/invoice/history" class="btn btn-secondary">
							Kembali
						</a>
						<button class="btn btn-danger" onclick="deleteInvoice()">
							Hapus
						</button>
					</div>
				</div>

				<div class="detail-container">
					<!-- Main Content -->
					<div>
						<!-- Informasi Dasar -->
						<div class="detail-card">
							<h3>Informasi Invoice</h3>
							<div class="detail-row">
								<div class="detail-label">Nomor Invoice:</div>
								<div class="detail-value"><%= invoice.invoice_number %></div>
							</div>
							<div class="detail-row">
								<div class="detail-label">Tanggal:</div>
								<div class="detail-value">
									<%= new Date(invoice.invoice_date).toLocaleDateString('id-ID')
									%>
								</div>
							</div>
							<% if (invoice.due_date) { %>
							<div class="detail-row">
								<div class="detail-label">Jatuh Tempo:</div>
								<div class="detail-value">
									<%= new Date(invoice.due_date).toLocaleDateString('id-ID') %>
								</div>
							</div>
							<% } %>
							<div class="detail-row">
								<div class="detail-label">Perusahaan:</div>
								<div class="detail-value"><%= invoice.company_name %></div>
							</div>
						</div>

						<!-- Data Penerima -->
						<div class="detail-card">
							<h3>Data Penerima</h3>
							<div class="detail-row">
								<div class="detail-label">Nama:</div>
								<div class="detail-value"><%= invoice.recipient_name %></div>
							</div>
							<div class="detail-row">
								<div class="detail-label">Telepon:</div>
								<div class="detail-value"><%= invoice.recipient_phone %></div>
							</div>
							<% if (invoice.recipient_npwp) { %>
							<div class="detail-row">
								<div class="detail-label">NPWP:</div>
								<div class="detail-value"><%= invoice.recipient_npwp %></div>
							</div>
							<% } %> <% if (invoice.recipient_address) { %>
							<div class="detail-row">
								<div class="detail-label">Alamat:</div>
								<div class="detail-value"><%= invoice.recipient_address %></div>
							</div>
							<% } %>
						</div>

						<!-- Daftar Item -->
						<div class="detail-card">
							<h3>Daftar Item</h3>
							<% if (invoice.items && invoice.items.length > 0) { %>
							<table class="items-table">
								<thead>
									<tr>
										<th>Deskripsi</th>
										<th style="text-align: center">Qty</th>
										<th style="text-align: right">Harga</th>
										<th style="text-align: right">Total</th>
									</tr>
								</thead>
								<tbody>
									<% let subtotal = 0; invoice.items.forEach(item => { const
									itemTotal = (item.quantity || 0) * (item.price || 0); subtotal
									+= itemTotal; %>
									<tr>
										<td><%= item.description || item.name %></td>
										<td style="text-align: center"><%= item.quantity %></td>
										<td style="text-align: right">
											Rp <%= (item.price || 0).toLocaleString('id-ID') %>
										</td>
										<td style="text-align: right">
											Rp <%= itemTotal.toLocaleString('id-ID') %>
										</td>
									</tr>
									<% }); %>
									<tr class="total-row">
										<td colspan="3" style="text-align: right">Subtotal:</td>
										<td class="total-value">
											Rp <%= subtotal.toLocaleString('id-ID') %>
										</td>
									</tr>
								</tbody>
							</table>
							<% } else { %>
							<p>Tidak ada item</p>
							<% } %>
						</div>

						<!-- Pajak -->
						<% if (invoice.taxes && invoice.taxes.length > 0) { %>
						<div class="detail-card">
							<h3>Pajak & Biaya</h3>
							<% invoice.taxes.forEach(tax => { %>
							<div class="detail-row">
								<div class="detail-label"><%= tax.name %>:</div>
								<div class="detail-value">
									Rp <%= (tax.amount || 0).toLocaleString('id-ID') %>
								</div>
							</div>
							<% }); %>
						</div>
						<% } %>

						<!-- Info Pembayaran -->
						<% if (invoice.bank_name) { %>
						<div class="detail-card">
							<h3>Informasi Pembayaran</h3>
							<div class="detail-row">
								<div class="detail-label">Bank:</div>
								<div class="detail-value"><%= invoice.bank_name %></div>
							</div>
							<div class="detail-row">
								<div class="detail-label">No. Rekening:</div>
								<div class="detail-value">
									<%= invoice.bank_account_number %>
								</div>
							</div>
							<div class="detail-row">
								<div class="detail-label">Atas Nama:</div>
								<div class="detail-value"><%= invoice.bank_account_name %></div>
							</div>
						</div>
						<% } %>
					</div>

					<!-- Sidebar -->
					<div>
						<!-- Total -->
						<div class="detail-card">
							<h3>Total</h3>
							<div class="detail-row">
								<div class="detail-label">Total:</div>
								<div
									class="detail-value"
									style="font-size: 1.5rem; color: #667eea; font-weight: bold"
								>
									Rp <%= (invoice.total_amount || 0).toLocaleString('id-ID') %>
								</div>
							</div>
						</div>

						<!-- Update Status -->
						<div class="detail-card">
							<h3>Update Status</h3>
							<div class="status-update">
								<select id="statusSelect" value="<%= invoice.status %>">
									<option value="draft">Draft</option>
									<option value="issued">Diterbitkan</option>
									<option value="sent">Terkirim</option>
									<option value="paid">Dibayar</option>
									<option value="overdue">Jatuh Tempo</option>
									<option value="cancelled">Dibatalkan</option>
								</select>
								<% if (invoice.status === 'paid') { %>
								<input
									type="date"
									id="paidDate"
									value="<%= invoice.paid_date ? new Date(invoice.paid_date).toISOString().split('T')[0] : '' %>"
								/>
								<% } %>
								<button
									class="btn btn-primary"
									onclick="updateStatus()"
									style="margin-top: 0.5rem"
								>
									Simpan
								</button>
							</div>
						</div>

						<!-- Share Link -->
						<div class="detail-card">
							<h3>Shared Link</h3>
							<div id="shareLinkContainer" style="display: none">
								<div class="share-link-box">
									<input type="text" id="shareLink" readonly />
									<button class="copy-btn" onclick="copyShareLink()">
										ðŸ“‹ Copy Link
									</button>
								</div>
							</div>
							<div id="noShareLinkMsg" style="color: #999; font-size: 0.9rem">
								<p>
									Belum ada shared link. Klik "Generate Share Link" untuk
									membuat.
								</p>
							</div>
						</div>

						<!-- Template Info -->
						<% if (invoice.template_name) { %>
						<div class="detail-card">
							<h3>Template Invoice</h3>
							<div class="detail-row">
								<div class="detail-label">Template:</div>
								<div class="detail-value"><%= invoice.template_name %></div>
							</div>
							<% if (invoice.logo_path) { %>
							<img
								src="<%= invoice.logo_path %>"
								alt="Logo"
								style="
									max-width: 100%;
									height: auto;
									margin-top: 1rem;
									border-radius: 4px;
								"
							/>
							<% } %>
						</div>
						<% } %>
					</div>
				</div>
			</main>
		</div>

		<script>
			// Hamburger Menu Toggle
			const hamburger = document.getElementById("hamburgerMenu")
			const sidebar = document.getElementById("sidebar")
			const overlay = document.getElementById("sidebarOverlay")

			function toggleSidebar() {
				sidebar.classList.toggle("active")
				overlay.classList.toggle("active")
			}

			function closeSidebar() {
				sidebar.classList.remove("active")
				overlay.classList.remove("active")
			}

			hamburger.addEventListener("click", toggleSidebar)
			overlay.addEventListener("click", closeSidebar)

			// Close sidebar when clicking nav items
			document.querySelectorAll(".nav-item").forEach((item) => {
				item.addEventListener("click", closeSidebar)
			})

			// Check if share token exists
			document.addEventListener("DOMContentLoaded", () => {
				const shareToken = "<%= invoice.share_token %>"
				if (shareToken) {
					const protocol = window.location.protocol
					const host = window.location.host
					const shareLink = `${protocol}//${host}/invoice/share/${shareToken}`

					document.getElementById("shareLink").value = shareLink
					document.getElementById("shareLinkContainer").style.display = "block"
					document.getElementById("noShareLinkMsg").style.display = "none"
				}
			})

			function generateShareLink() {
				if (confirm("Generate share link baru?")) {
					fetch("/admin/invoice/<%= invoice.id %>/generate-share", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
					})
						.then((res) => res.json())
						.then((data) => {
							if (data.success) {
								document.getElementById("shareLink").value = data.shareUrl
								document.getElementById("shareLinkContainer").style.display =
									"block"
								document.getElementById("noShareLinkMsg").style.display = "none"
								alert("Share link berhasil dibuat!")
							} else {
								alert("Error: " + data.error)
							}
						})
						.catch((err) => {
							console.error("Error:", err)
							alert("Terjadi kesalahan")
						})
				}
			}

			function copyShareLink() {
				const shareLink = document.getElementById("shareLink")
				shareLink.select()
				document.execCommand("copy")
				alert("Share link telah disalin ke clipboard!")
			}

			function updateStatus() {
				const status = document.getElementById("statusSelect").value
				const paidDate = document.getElementById("paidDate")?.value

				fetch("/admin/invoice/<%= invoice.id %>/status", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify({ status, paid_date: paidDate || null }),
				})
					.then((res) => res.json())
					.then((data) => {
						if (data.success) {
							alert("Status berhasil diupdate!")
							location.reload()
						} else {
							alert("Error: " + data.error)
						}
					})
			}

			function deleteInvoice() {
				if (
					confirm(
						"Anda yakin ingin menghapus invoice ini? Aksi ini tidak dapat dibatalkan.",
					)
				) {
					fetch("/admin/invoice/<%= invoice.id %>/delete", {
						method: "DELETE",
					})
						.then((res) => res.json())
						.then((data) => {
							if (data.success) {
								alert("Invoice berhasil dihapus")
								window.location.href = "/admin/invoice/history"
							} else {
								alert("Error: " + data.error)
							}
						})
				}
			}
		</script>
	</body>
</html>
