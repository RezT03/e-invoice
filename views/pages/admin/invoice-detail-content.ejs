<div class="detail-container-main">
	<!-- Header dengan nomor invoice dan aksi -->
	<div class="detail-header">
		<div>
			<div class="invoice-number-display">
				<%= invoice.invoice_number %>
			</div>
			<span class="invoice-status status-<%= invoice.status %>">
				<%= invoice.status.toUpperCase() %>
			</span>
		</div>
		<div class="action-buttons">
			<a
				href="/admin/invoice/<%= invoice.id %>/pdf/normal"
				class="btn btn-primary"
				download
			>
				Download PDF
			</a>
			<button class="btn btn-success" onclick="generateShareLink()">
				Generate Share Link
			</button>
			<a href="/admin/invoice/history" class="btn btn-secondary">
				Kembali
			</a>
			<button class="btn btn-danger" onclick="deleteInvoice()">
				Hapus
			</button>
		</div>
	</div>

	<div class="detail-container">
		<!-- Main Content -->
		<div>
			<!-- Informasi Dasar -->
			<div class="detail-card">
				<h3>Informasi Invoice</h3>
				<div class="detail-row">
					<div class="detail-label">Nomor Invoice:</div>
					<div class="detail-value"><%= invoice.invoice_number %></div>
				</div>
				<div class="detail-row">
					<div class="detail-label">Tanggal:</div>
					<div class="detail-value">
						<%= new Date(invoice.invoice_date).toLocaleDateString('id-ID') %>
					</div>
				</div>
				<% if (invoice.due_date) { %>
				<div class="detail-row">
					<div class="detail-label">Jatuh Tempo:</div>
					<div class="detail-value">
						<%= new Date(invoice.due_date).toLocaleDateString('id-ID') %>
					</div>
				</div>
				<% } %>
				<div class="detail-row">
					<div class="detail-label">Perusahaan:</div>
					<div class="detail-value"><%= invoice.company_name %></div>
				</div>
			</div>

			<!-- Data Penerima -->
			<div class="detail-card">
				<h3>Data Penerima</h3>
				<div class="detail-row">
					<div class="detail-label">Nama:</div>
					<div class="detail-value"><%= invoice.recipient_name %></div>
				</div>
				<div class="detail-row">
					<div class="detail-label">Telepon:</div>
					<div class="detail-value"><%= invoice.recipient_phone %></div>
				</div>
				<% if (invoice.recipient_npwp) { %>
				<div class="detail-row">
					<div class="detail-label">NPWP:</div>
					<div class="detail-value"><%= invoice.recipient_npwp %></div>
				</div>
				<% } %>
				<% if (invoice.recipient_address) { %>
				<div class="detail-row">
					<div class="detail-label">Alamat:</div>
					<div class="detail-value"><%= invoice.recipient_address %></div>
				</div>
				<% } %>
			</div>

			<!-- Daftar Item -->
			<div class="detail-card">
				<h3>Daftar Item</h3>
				<% if (invoice.items && invoice.items.length > 0) { %>
				<table class="items-table">
					<thead>
						<tr>
							<th>Deskripsi</th>
							<th style="text-align: center">Qty</th>
							<th style="text-align: right">Harga</th>
							<th style="text-align: right">Total</th>
						</tr>
					</thead>
					<tbody>
						<% let subtotal = 0; invoice.items.forEach(item => { const
						itemTotal = (item.quantity || 0) * (item.price || 0); subtotal
						+= itemTotal; %>
						<tr>
							<td><%= item.description || item.name %></td>
							<td style="text-align: center"><%= item.quantity %></td>
							<td style="text-align: right">
								Rp <%= Math.round(item.price || 0).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
							</td>
							<td style="text-align: right">
								Rp <%= Math.round(itemTotal).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
							</td>
						</tr>
						<% }); %>
					<tr class="total-row">
						<td colspan="3" style="text-align: right">Subtotal:</td>
						<td class="total-value">
							Rp <%= Math.round(subtotal).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
						</td>
					</tr>
					</tbody>
				</table>
				<% } else { %>
				<p>Tidak ada item</p>
				<% } %>
			</div>

			<!-- Pajak -->
			<% if (invoice.taxes && invoice.taxes.length > 0) { %>
			<div class="detail-card">
				<h3>Pajak & Biaya</h3>
				<% invoice.taxes.forEach(tax => { %>
				<div class="detail-row">
					<div class="detail-label"><%= tax.name %>:</div>
					<div class="detail-value">
						Rp <%= Math.round(tax.amount || 0).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
					</div>
				</div>
				<% }); %>
			</div>
			<% } %>

			<!-- Info Pembayaran -->
			<% if (invoice.bank_name) { %>
			<div class="detail-card">
				<h3>Informasi Pembayaran</h3>
				<div class="detail-row">
					<div class="detail-label">Bank:</div>
					<div class="detail-value"><%= invoice.bank_name %></div>
				</div>
				<div class="detail-row">
					<div class="detail-label">No. Rekening:</div>
					<div class="detail-value">
						<%= invoice.bank_account_number %>
					</div>
				</div>
				<div class="detail-row">
					<div class="detail-label">Atas Nama:</div>
					<div class="detail-value"><%= invoice.bank_account_name %></div>
				</div>
			</div>
			<% } %>
		</div>

		<!-- Sidebar -->
		<div>
			<!-- Total -->
			<div class="detail-card">
				<h3>Total</h3>
				<div class="detail-row">
					<div class="detail-label">Total:</div>
					<div
						class="detail-value"
						style="font-size: 1.5rem; color: #667eea; font-weight: bold"
					>
						Rp <%= Math.round(invoice.total_amount || 0).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
					</div>
				</div>
			</div>

			<!-- Update Status -->
			<div class="detail-card">
				<h3>Update Status</h3>
				<div class="status-update">
					<select id="statusSelect">
						<option value="draft" <%= invoice.status === 'draft' ? 'selected' : '' %>>Draft</option>
						<option value="issued" <%= invoice.status === 'issued' ? 'selected' : '' %>>Diterbitkan</option>
						<option value="sent" <%= invoice.status === 'sent' ? 'selected' : '' %>>Terkirim</option>
						<option value="paid" <%= invoice.status === 'paid' ? 'selected' : '' %>>Dibayar</option>
						<option value="overdue" <%= invoice.status === 'overdue' ? 'selected' : '' %>>Jatuh Tempo</option>
						<option value="cancelled" <%= invoice.status === 'cancelled' ? 'selected' : '' %>>Dibatalkan</option>
					</select>
					<% if (invoice.status === 'paid') { %>
					<input
						type="date"
						id="paidDate"
						value="<%= invoice.paid_date ? new Date(invoice.paid_date).toISOString().split('T')[0] : '' %>"
					/>
					<% } %>
					<button
						class="btn btn-primary"
						onclick="updateStatus()"
						style="margin-top: 0.5rem"
					>
						Simpan
					</button>
				</div>
			</div>

			<!-- Share Link -->
			<div class="detail-card">
				<h3>Shared Link</h3>
				<div id="shareLinkContainer" style="display: none">
					<div class="share-link-box">
						<input type="text" id="shareLink" readonly />
						<button class="copy-btn" onclick="copyShareLink()">
							Copy Link
						</button>
					</div>
				</div>
				<div id="noShareLinkMsg" style="color: #999; font-size: 0.9rem">
					<p>
						Belum ada shared link. Klik "Generate Share Link" untuk
						membuat.
					</p>
				</div>
			</div>

			<!-- Template Info -->
			<% if (invoice.template_name) { %>
			<div class="detail-card">
				<h3>Template Invoice</h3>
				<div class="detail-row">
					<div class="detail-label">Template:</div>
					<div class="detail-value"><%= invoice.template_name %></div>
				</div>
				<% if (invoice.logo_path) { %>
				<img
					src="<%= invoice.logo_path %>"
					alt="Logo"
					style="
						max-width: 100%;
						height: auto;
						margin-top: 1rem;
						border-radius: 4px;
					"
				/>
				<% } %>
			</div>
			<% } %>
		</div>
	</div>
</div>

<div data-invoice-id="<%= invoice.id %>" style="display: none"></div>
<div data-share-token="<%= invoice.share_token %>" style="display: none"></div>

<script src="/js/invoice-detail.js"></script>
