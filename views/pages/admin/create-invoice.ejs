<!DOCTYPE html>
<html lang="id">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Buat Invoice - Admin Dashboard</title>
		<link rel="stylesheet" href="/css/admin-style.css" />
		<style>
			.form-container {
				background: white;
				padding: 2rem;
				border-radius: 8px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.form-section {
				margin-bottom: 2rem;
				padding-bottom: 2rem;
				border-bottom: 1px solid #eee;
			}

			.form-section:last-child {
				border-bottom: none;
			}

			.form-section h3 {
				margin-bottom: 1rem;
				color: #333;
				font-size: 1.1rem;
			}

			.form-row {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1.5rem;
				margin-bottom: 1.5rem;
			}

			.form-row.full {
				grid-template-columns: 1fr;
			}

			.form-group {
				display: flex;
				flex-direction: column;
			}

			.form-group label {
				margin-bottom: 0.5rem;
				color: #555;
				font-weight: 500;
				font-size: 0.95rem;
			}

			.form-group input,
			.form-group select,
			.form-group textarea {
				padding: 0.75rem;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 0.95rem;
				font-family: inherit;
				transition: border-color 0.2s;
			}

			.form-group input:focus,
			.form-group select:focus,
			.form-group textarea:focus {
				outline: none;
				border-color: #667eea;
				box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
			}

			.form-group textarea {
				resize: vertical;
				min-height: 100px;
			}

			.items-section {
				background: #f8f9fa;
				padding: 1.5rem;
				border-radius: 4px;
				margin-top: 1rem;
			}

			.item-row {
				display: grid;
				grid-template-columns: 2fr 1fr 0.75fr 1fr 1fr 0.5fr;
				gap: 1rem;
				margin-bottom: 1rem;
				align-items: flex-end;
				padding: 0.75rem;
				background: white;
				border: 1px solid #e0e0e0;
				border-radius: 4px;
			}

			.item-row input,
			.item-row .item-total {
				padding: 0.75rem;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 0.9rem;
			}

			.item-total {
				background: #f9f9f9;
				border: 1px solid #e0e0e0;
				font-weight: 600;
				color: #333;
				text-align: right;
				display: flex;
				align-items: center;
				justify-content: flex-end;
			}

			.btn-remove {
				padding: 0.5rem 1rem;
				background: #dc3545;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 0.9rem;
				transition: background 0.2s;
			}

			.btn-remove:hover {
				background: #c82333;
			}

			.btn-add {
				padding: 0.75rem 1.5rem;
				background: #28a745;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 0.95rem;
				margin-top: 0.5rem;
				transition: background 0.2s;
			}

			.btn-add:hover {
				background: #218838;
			}

			.tax-row {
				display: grid;
				grid-template-columns: 1fr 1fr 0.5fr;
				gap: 1rem;
				margin-bottom: 1rem;
				align-items: flex-end;
			}

			.tax-row input {
				padding: 0.75rem;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 0.9rem;
			}

			.form-actions {
				display: flex;
				gap: 1rem;
				margin-top: 2rem;
				padding-top: 2rem;
				border-top: 1px solid #eee;
			}

			.btn-submit {
				padding: 0.75rem 2rem;
				background: #667eea;
				color: white;
				border: none;
				border-radius: 4px;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: background 0.2s;
			}

			.btn-submit:hover {
				background: #5568d3;
			}

			.btn-cancel {
				padding: 0.75rem 2rem;
				background: #6c757d;
				color: white;
				border: none;
				border-radius: 4px;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: background 0.2s;
			}

			.btn-cancel:hover {
				background: #5a6268;
			}

			.template-selector {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
				gap: 1rem;
				margin-top: 1rem;
			}

			.template-option {
				padding: 1rem;
				border: 2px solid #ddd;
				border-radius: 4px;
				text-align: center;
				cursor: pointer;
				transition: all 0.2s;
			}

			.template-option:hover {
				border-color: #667eea;
				background: #f8f9ff;
			}

			.template-option input {
				display: none;
			}

			.template-option input:checked + label {
				color: #667eea;
				font-weight: 600;
			}

			.template-option.selected {
				border-color: #667eea;
				background: #f0f4ff;
			}

			.logo-preview {
				max-height: 60px;
				margin-bottom: 0.5rem;
			}

			.discount-section {
				background: #f0f7ff;
				padding: 1.5rem;
				border-radius: 4px;
				border-left: 4px solid #28a745;
				margin-bottom: 2rem;
			}

			.discount-row {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1.5rem;
			}

			.discount-info {
				background: white;
				padding: 1rem;
				border-radius: 4px;
				border: 1px solid #e0e0e0;
				margin-top: 1rem;
				font-size: 0.9rem;
				color: #666;
			}

			@media (max-width: 768px) {
				.form-row,
				.item-row,
				.tax-row,
				.discount-row {
					grid-template-columns: 1fr;
				}

				.item-row {
					grid-template-columns: 1fr;
				}

				.form-actions {
					flex-direction: column;
				}

				.btn-submit,
				.btn-cancel {
					width: 100%;
				}

				.discount-section {
					padding: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="admin-container">
			<!-- Sidebar Overlay -->
			<div class="sidebar-overlay" id="sidebarOverlay"></div>

			<!-- Sidebar -->
			<aside class="sidebar" id="sidebar">
				<div class="sidebar-header">
					<h2>E-Invoice</h2>
					<p>Restu Production</p>
				</div>

				<nav class="sidebar-nav">
					<a href="/admin/invoice/dashboard" class="nav-item">
						<span class="icon">ðŸ“Š</span>
						<span class="label">Dashboard</span>
					</a>
					<a href="/admin/invoice/create" class="nav-item active">
						<span class="icon">âž•</span>
						<span class="label">Buat Invoice</span>
					</a>
					<a href="/admin/invoice/history" class="nav-item">
						<span class="icon">ðŸ“‹</span>
						<span class="label">Riwayat Invoice</span>
					</a>
				</nav>

				<div class="sidebar-footer">
					<a href="/auth/logout" class="logout-btn">
						<span class="icon">ðŸšª</span>
						<span class="label">Logout</span>
					</a>
				</div>
			</aside>

			<!-- Main Content -->
			<main class="main-content">
				<div class="top-bar">
					<div class="top-bar-left">
						<button class="hamburger-menu" id="hamburgerMenu">â˜°</button>
						<h1>Buat Invoice Baru</h1>
					</div>
				</div>

				<div class="form-container">
					<form
						id="createInvoiceForm"
						action="/admin/invoice/create"
						method="POST"
					>
						<!-- Informasi Perusahaan -->
						<div class="form-section">
							<h3>Informasi Perusahaan</h3>

							<div class="form-row">
								<div class="form-group">
									<label for="company_id">Perusahaan *</label>
									<select id="company_id" name="company_id" required>
										<option value="">-- Pilih Perusahaan --</option>
										<% companies.forEach(company => { %>
										<option value="<%= company.id %>">
											<%= company.name %>
										</option>
										<% }); %>
									</select>
								</div>
							</div>
						</div>
						<!-- Informasi Invoice -->
						<div class="form-section">
							<h3>Informasi Invoice</h3>

							<div class="form-row">
								<div class="form-group">
									<label for="invoice_number">Nomor Invoice *</label>
									<input
										type="text"
										id="invoice_number"
										name="invoice_number"
										placeholder="INV-2025-001"
										required
									/>
								</div>
								<div class="form-group">
									<label for="status">Status</label>
									<select id="status" name="status">
										<option value="draft">Draft</option>
										<option value="issued">Diterbitkan</option>
										<option value="sent">Terkirim</option>
										<option value="paid">Dibayar</option>
									</select>
								</div>
							</div>

							<div class="form-row">
								<div class="form-group">
									<label for="invoice_date">Tanggal Invoice *</label>
									<input
										type="date"
										id="invoice_date"
										name="invoice_date"
										required
									/>
								</div>
								<div class="form-group">
									<label for="due_date">Tanggal Jatuh Tempo</label>
									<input type="date" id="due_date" name="due_date" />
								</div>
							</div>
						</div>

						<!-- Data Penerima -->
						<div class="form-section">
							<h3>Data Penerima Invoice</h3>

							<div class="form-row">
								<div class="form-group">
									<label for="recipient_name">Nama Penerima *</label>
									<input
										type="text"
										id="recipient_name"
										name="recipient_name"
										placeholder="Nama lengkap"
										required
									/>
								</div>
								<div class="form-group">
									<label for="recipient_phone">Nomor Telepon *</label>
									<input
										type="tel"
										id="recipient_phone"
										name="recipient_phone"
										placeholder="08123456789"
										required
									/>
								</div>
							</div>

							<div class="form-row">
								<div class="form-group">
									<label for="recipient_npwp">NPWP</label>
									<input
										type="text"
										id="recipient_npwp"
										name="recipient_npwp"
										placeholder="12.345.678.9-012.000"
									/>
								</div>
							</div>

							<div class="form-row full">
								<div class="form-group">
									<label for="recipient_address">Alamat</label>
									<textarea
										id="recipient_address"
										name="recipient_address"
										placeholder="Alamat lengkap penerima"
									></textarea>
								</div>
							</div>
						</div>

						<!-- Items/Daftar Barang -->
						<div class="form-section">
							<h3>Daftar Barang/Jasa</h3>
							<p style="font-size: 0.9em; color: #666; margin-bottom: 1rem">
								ðŸ’¡
								<strong>Tips:</strong>
								Anda bisa copy-paste banyak baris dari Excel/Google Sheets
								langsung ke kolom pertama (Deskripsi)
							</p>

							<div class="items-section">
								<div id="itemsContainer"></div>
								<button type="button" class="btn-add" onclick="addItem()">
									+ Tambah Item
								</button>
							</div>

							<input type="hidden" id="items" name="items" value="[]" />
						</div>

						<!-- Diskon -->
						<div class="form-section">
							<h3>Diskon (Opsional)</h3>
							<div class="discount-section">
								<div class="discount-row">
									<div class="form-group">
										<label for="discount_type">Tipe Diskon:</label>
										<select
											id="discount_type"
											name="discount_type"
											onchange="updateDiscountLabel()"
										>
											<option value="none">Tanpa Diskon</option>
											<option value="percentage">Persentase (%)</option>
											<option value="nominal">Nominal (Rp)</option>
										</select>
									</div>
									<div class="form-group">
										<label id="discountLabel" for="discount_value">
											Diskon (%):
										</label>
										<input
											type="number"
											id="discount_value"
											name="discount_value"
											placeholder="Misal: 10 untuk 10%"
											step="0.01"
											min="0"
										/>
									</div>
								</div>
								<div
									id="discountInfo"
									class="discount-info"
									style="display: none"
								>
									Total Diskon:
									<strong id="discountAmount">Rp 0</strong>
								</div>
							</div>
						</div>

						<!-- Pajak -->
						<div class="form-section">
							<h3>Pajak & Biaya Tambahan</h3>

							<div class="items-section">
								<div id="taxesContainer"></div>
								<button type="button" class="btn-add" onclick="addTax()">
									+ Tambah Pajak/Biaya
								</button>
							</div>

							<input type="hidden" id="taxes" name="taxes" value="[]" />
						</div>

						<!-- Form Actions -->
						<div class="form-actions">
							<button type="submit" class="btn-submit">Buat Invoice</button>
							<a
								href="/admin/invoice/history"
								class="btn-cancel"
								style="text-decoration: none; text-align: center"
							>
								Batal
							</a>
						</div>
					</form>
				</div>
			</main>
		</div>

		<script>
			// Hamburger Menu Toggle
			const hamburger = document.getElementById("hamburgerMenu")
			const sidebar = document.getElementById("sidebar")
			const overlay = document.getElementById("sidebarOverlay")

			function toggleSidebar() {
				sidebar.classList.toggle("active")
				overlay.classList.toggle("active")
			}

			function closeSidebar() {
				sidebar.classList.remove("active")
				overlay.classList.remove("active")
			}

			hamburger.addEventListener("click", toggleSidebar)
			overlay.addEventListener("click", closeSidebar)

			// Close sidebar when clicking nav items
			document.querySelectorAll(".nav-item").forEach((item) => {
				item.addEventListener("click", closeSidebar)
			})

			// Set default date to today
			document.getElementById("invoice_date").valueAsDate = new Date()

			// Parse currency string to number (e.g., "Rp 50.000" -> 50000)
			function parseCurrency(str) {
				if (!str) return 0
				let cleaned = str.replace(/Rp\s?/i, "").trim()
				cleaned = cleaned.replace(/\./g, "")
				cleaned = cleaned.replace(",", ".")
				return parseFloat(cleaned) || 0
			}

			// Escape HTML untuk prevent XSS
			function escapeHtml(text) {
				const map = {
					"&": "&amp;",
					"<": "&lt;",
					">": "&gt;",
					'"': "&quot;",
					"'": "&#039;",
				}
				return text.replace(/[&<>"']/g, (m) => map[m])
			}

			// Items management
			function addItem() {
				const container = document.getElementById("itemsContainer")
				const index = container.children.length

				const row = document.createElement("div")
				row.className = "item-row"
				row.innerHTML = `
        <input type="text" placeholder="Deskripsi item" class="item-description" onpaste="handleItemPaste(event)">
        <input type="text" placeholder="Satuan" class="item-unit">
        <input type="number" placeholder="Qty" class="item-qty" value="" min="1" oninput="updateItemTotal(this)">
        <input type="number" placeholder="Harga" class="item-price" value="" min="0" step="0.01" oninput="updateItemTotal(this)">
        <div class="item-total">0</div>
        <button type="button" class="btn-remove" onclick="this.parentElement.remove(); updateItems();">Hapus</button>
      `

				container.appendChild(row)
				row.addEventListener("change", updateItems)
				row.addEventListener("input", updateItems)
			}

			// Handle paste event untuk multi-row items
			function handleItemPaste(event) {
				// Only trigger on first input
				if (event.target.classList.contains("item-qty")) return

				event.preventDefault()
				const clipboardData = event.clipboardData || window.clipboardData
				const pastedText = clipboardData.getData("text")

				if (!pastedText) return

				// Split by newline
				let rows = pastedText.trim().split("\n")

				// Get current container
				const container = document.getElementById("itemsContainer")
				const currentRow = event.target.closest(".item-row")

				// Remove current empty row if empty
				if (currentRow) {
					const inputs = currentRow.querySelectorAll("input")
					const isEmpty = Array.from(inputs).every((i) => !i.value)
					if (isEmpty) {
						currentRow.remove()
					}
				}

				// Parse each row
				rows.forEach((rowText) => {
					rowText = rowText.trim()
					if (!rowText) return

					// Try to split by tab first
					let cells = rowText.split("\t").map((c) => c.trim())

					// Single cell - treat as item name
					if (cells.length === 1) {
						cells = [cells[0]]
					}

					if (cells[0]) {
						const [name, unit, qty, price] = [
							cells[0] || "",
							cells[1] || "",
							cells[2] || "",
							cells[3] || "",
						]

						const row = document.createElement("div")
						row.className = "item-row"
						const numQty = qty ? parseInt(qty) : 0
						const numPrice = price ? parseCurrency(price) : 0
						const total = numQty * numPrice

						row.innerHTML = `
            <input type="text" value="${escapeHtml(
							name,
						)}" placeholder="Deskripsi item" class="item-description">
            <input type="text" value="${escapeHtml(
							unit,
						)}" placeholder="Satuan" class="item-unit">
            <input type="number" value="${numQty}" placeholder="Qty" class="item-qty" min="1" oninput="updateItemTotal(this)">
            <input type="number" value="${numPrice}" placeholder="Harga" class="item-price" min="0" step="0.01" oninput="updateItemTotal(this)">
            <div class="item-total">${total.toLocaleString("id-ID")}</div>
            <button type="button" class="btn-remove" onclick="this.parentElement.remove(); updateItems();">Hapus</button>
          `

						container.appendChild(row)
						row.addEventListener("change", updateItems)
						row.addEventListener("input", updateItems)
					}
				})

				updateItems()
			}

			// Update total harga per item
			function updateItemTotal(input) {
				const row = input.closest(".item-row")
				const qtyInput = row.querySelector(".item-qty")
				const priceInput = row.querySelector(".item-price")
				const totalSpan = row.querySelector(".item-total")

				const qty = parseFloat(qtyInput.value) || 0
				const price = parseFloat(priceInput.value) || 0
				const total = qty * price

				totalSpan.textContent = total.toLocaleString("id-ID")
				updateItems()
			}

			function updateItems() {
				const container = document.getElementById("itemsContainer")
				const items = []

				container.querySelectorAll(".item-row").forEach((row) => {
					const description = row.querySelector(".item-description").value
					const unit = row.querySelector(".item-unit").value
					const quantity = parseFloat(row.querySelector(".item-qty").value) || 0
					const price = parseFloat(row.querySelector(".item-price").value) || 0

					if (description && quantity && price) {
						items.push({ description, unit, quantity, price })
					}
				})

				document.getElementById("items").value = JSON.stringify(items)
			}

			// Discount management
			function updateDiscountLabel() {
				const type = document.getElementById("discount_type").value
				const label = document.getElementById("discountLabel")
				const input = document.getElementById("discount_value")
				const info = document.getElementById("discountInfo")

				if (type === "percentage") {
					label.textContent = "Diskon (%):"
					input.placeholder = "Misal: 10 untuk 10%"
					input.step = "0.01"
				} else if (type === "nominal") {
					label.textContent = "Diskon (Rp):"
					input.placeholder = "Misal: 50000"
					input.step = "1"
				}

				if (type === "none") {
					input.value = 0
					info.style.display = "none"
				}
			}

			// Taxes management
			function addTax() {
				const container = document.getElementById("taxesContainer")

				const row = document.createElement("div")
				row.className = "tax-row"
				row.innerHTML = `
        <input type="text" placeholder="Nama pajak/biaya" class="tax-name">
        <input type="number" placeholder="Persentase %" class="tax-percentage" value="0" min="0" max="100" step="0.01">
        <button type="button" class="btn-remove" onclick="this.parentElement.remove(); updateTaxes();">Hapus</button>
      `

				container.appendChild(row)
				row.addEventListener("change", updateTaxes)
				row.addEventListener("input", updateTaxes)
			}

			function updateTaxes() {
				const container = document.getElementById("taxesContainer")
				const taxes = []

				container.querySelectorAll(".tax-row").forEach((row) => {
					const name = row.querySelector(".tax-name").value
					const percentage =
						parseFloat(row.querySelector(".tax-percentage").value) || 0

					if (name && percentage) {
						taxes.push({ name, percentage })
					}
				})

				document.getElementById("taxes").value = JSON.stringify(taxes)
			}

			// Add first item by default
			document.addEventListener("DOMContentLoaded", () => {
				addItem()
			})

			// Form submit
			document
				.getElementById("createInvoiceForm")
				.addEventListener("submit", async (e) => {
					e.preventDefault()

					updateItems()
					updateTaxes()

					// Ambil data dari form dengan cara yang lebih aman
					const formElement = e.target
					const formData = {
						company_id: formElement.querySelector('[name="company_id"]').value,
						invoice_number: formElement.querySelector('[name="invoice_number"]')
							.value,
						status: formElement.querySelector('[name="status"]').value,
						invoice_date: formElement.querySelector('[name="invoice_date"]')
							.value,
						due_date: formElement.querySelector('[name="due_date"]').value,
						recipient_name: formElement.querySelector('[name="recipient_name"]')
							.value,
						recipient_phone: formElement.querySelector(
							'[name="recipient_phone"]',
						).value,
						recipient_npwp: formElement.querySelector('[name="recipient_npwp"]')
							.value,
						recipient_address: formElement.querySelector(
							'[name="recipient_address"]',
						).value,
						items: formElement.querySelector('[name="items"]').value,
						taxes: formElement.querySelector('[name="taxes"]').value,
						discount_type: formElement.querySelector('[name="discount_type"]')
							.value,
						discount_value:
							parseFloat(
								formElement.querySelector('[name="discount_value"]').value,
							) || 0,
					}

					try {
						const response = await fetch("/admin/invoice/create", {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify(formData),
						})

						const result = await response.json()

						if (result.success) {
							alert("Invoice berhasil dibuat!")
							window.location.href = `/admin/invoice/${result.id}`
						} else {
							alert("Error: " + (result.error || "Terjadi kesalahan"))
						}
					} catch (error) {
						console.error("Submit error:", error)
						alert("Error: " + error.message)
					}
				})
		</script>
	</body>
</html>
